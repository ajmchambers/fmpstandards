/*******************************************************************************
 * ChecksumCRC32 ( asciiText )
 * Computes a cyclic redundancy check (32 bit) for a string of text.
 *
 * @parameter asciiText: Text with character codes between 0 and 255.
 *
 * @return A number representing a 32-bit checksum
 *
 * @history 2014-01-05 - Jeremy Bante <http://scr.im/jbante> - Created
 * @history 2015-01-13 - Jeremy Bante <http://scr.im/jbante> - Improving XOR
 * speed with binary rather than decimal representation
 *
 * @see http://en.wikipedia.org/wiki/Cyclic_redundancy_check
 ******************************************************************************/

Case (
	/* Step 0, set-up */
	not $_crc.step ;
		Let ( [
			// initialize checksum with 0xffffffff (2^32 - 1)
			$_crc.crc = 311311311311311311311311311311311311311311311311 ;
			$_crc.i = 1 ;
			$_crc.byte = Code ( Middle ( asciiText ; $_crc.i ; 1 ) ) ;
			$_crc.step =
				Case (
					IsEmpty ( $_crc.byte ) ; -1 ;
					$_crc.byte > 255 ; -2 ;	// out of range
					/* Else */ 1
				)
		] ;
			ChecksumCRC32 ( asciiText )
		) ;

	/* Step 1, accumulate CRC */
	$_crc.step = 1 ;
		Let ( [
			_binaryByte =
				3
				& Choose ( Div ( $_crc.byte ; 16 ) ;
					"00300" ; "00301" ; "00310" ; "00311" ;
					"01300" ; "01301" ; "01310" ; "01311" ;
					"10300" ; "10301" ; "10310" ; "10311" ;
					"11300" ; "11301" ; "11310" ; "11311"
				)
				& 3
				& Choose ( Mod ( $_crc.byte ; 16 ) ;
					"00300" ; "00301" ; "00310" ; "00311" ;
					"01300" ; "01301" ; "01310" ; "01311" ;
					"10300" ; "10301" ; "10310" ; "10311" ;
					"11300" ; "11301" ; "11310" ; "11311"
				) ;
			_crc8LeastSignificantBits = Mod ( $_crc.crc ; 1000000000000 ) ;
			_binaryTableIndex =	// _crc8LeastSignificantBits XOR _binaryByte
				Substitute ( _crc8LeastSignificantBits + _binaryByte ;
					[ 2 ; 0 ] ;
					[ 6 ; 3 ]
				) ;
			_tableIndex =	// convert to decimal
				Evaluate (
					"( ( ( "
					& Substitute ( 4 & _binaryTableIndex ;
						[ "43" ; "" ] ;
						[ 3 ; " ) * 4 + " ] ;
						[ "00" ; 0 ] ;
						[ "01" ; 1 ] ;
						[ "10" ; 2 ] ;
						[ "11" ; 3 ]
					)
				) ;
			_tableValue =
				Choose ( _tableIndex ;
					300300300300300300300300300300300300300300300300 ;
					301311301311300300301311300311300300310301301310 ;
					311310311310300300311310301310300301300310311300 ;
					310301310301300300310301301301300301310311310310 ;
					300300301311301310311301311300301300300301310301 ;
					301311300300301310310310311311301300310300311311 ;
					311310310301301310300311310310301301300311301301 ;
					310301311310301310301300310301301301310310300311 ;
					300300311310311301310311310300310300300311300310 ;
					301311310301311301311300310311310300310310301300 ;
					311310300300311301301301311310310301300301311310 ;
					310301301311311301300310311301310301310300310300 ;
					300300310301310311301310301300311300300310310311 ;
					301311311310310311300301301311311300310311311301 ;
					311310301311310311310300300310311301300300301311 ;
					310301300300310311311311300301311301310301300301 ;
					300301311301310311301311300301300300301310301300 ;
					301310310310310311300300300310300300311311300310 ;
					311311300311310311310301301311300301301300310300 ;
					310300301300310311311310301300300301311301311310 ;
					300301310310311301310310311301301300301311311301 ;
					301310311301311301311301311310301300311310310311 ;
					311311301300311301301300310311301301301301300301 ;
					310300300311311301300311310300301301311300301311 ;
					300301300311301310311300310301310300301301301310 ;
					301310301300301310310311310310310300311300300300 ;
					311311311301301310300310311311310301301311310310 ;
					310300310310301310301301311300310301311310311300 ;
					300301301300300300300301301301311300301300311311 ;
					301310300311300300301310301310311300311301310301 ;
					311311310310300300311311300311311301301310300311 ;
					310300311301300300310300300300311301311311301301 ;
					300311310311301310311310300310300300311300310300 ;
					301300311300301310310301300301300300301301311310 ;
					311301301301301310300300301300300301311310301300 ;
					310310300310301310301311301311300301301311300310 ;
					300311311300300300300311311310301300311301300301 ;
					301300310311300300301300311301301300301300301311 ;
					311301300310300300311301310300301301311311311301 ;
					310310301301300300310310310311301301301310310311 ;
					300311301301310311301301310310310300311311310310 ;
					301300300310310311300310310301310300301310311300 ;
					311301310311310311310311311300310301311301301310 ;
					310310311300310311311300311311310301301300300300 ;
					300311300310311301310300301310311300311310300311 ;
					301300301301311301311311301301311300301311301301 ;
					311301311300311301301310300300311301311300311311 ;
					310310310311311301300301300311311301301301310301 ;
					300310301310311301310301300311300300310310311300 ;
					301301300301311301311310300300300300300311310310 ;
					311300310300311301301311301301300301310300300300 ;
					310311311311311301300300301310300301300301301310 ;
					300310300301310311301300311311301300310311301301 ;
					301301301310310311300311311300301300300310300311 ;
					311300311311310311310310310301301301310301310301 ;
					310311310300310311311301310310301301300300311311 ;
					300310310300300300300310310311310300310301311310 ;
					301301311311300300301301310300310300300300310300 ;
					311300301310300300311300311301310301310311300310 ;
					310311300301300300310311311310310301300310301300 ;
					300310311311301310311311301311311300310300301311 ;
					301301310300301310310300301300311300300301300301 ;
					311300300301301310300301300301311301310310310311 ;
					310311301310301310301310300310311301300311311301 ;
					301311301310311301311300301300300301310301300300 ;
					300300300301311301310311301311300301300300301310 ;
					310301310300311301300310300310300300310311311300 ;
					311310311311311301301301300301300300300310310310 ;
					301311300301310311300301310300301301310300310301 ;
					300300301310310311301310310311301301300301311311 ;
					310301311311310311311311311310301300310310301301 ;
					311310310300310311310300311301301300300311300311 ;
					301311310300300300301311311300310301310310300310 ;
					300300311311300300300300311311310301300311301300 ;
					310301301310300300310301310310310300310300311310 ;
					311310300301300300311310310301310300300301310300 ;
					301311311311301310310310300300311301310311310311 ;
					300300310300301310311301300311311301300310311301 ;
					310301300301301310301300301310311300310301301311 ;
					311310301310301310300311301301311300300300300301 ;
					301310310311301310310311301301300301311311301300 ;
					300301311300301310311300301310300301301310300310 ;
					310300301301301310301301300311300300311301310300 ;
					311311300310301310300310300300300300301300311310 ;
					301310311300300300301310310301301301311310311301 ;
					300301310311300300300301310310301301301311310311 ;
					310300300310300300310300311311301300311300300301 ;
					311311301301300300311311311300301300301301301311 ;
					301310301301310311300300311301310301311300301310 ;
					300301300310310311301311311310310301301301300300 ;
					310300310311310311311310310311310300311310310310 ;
					311311311300310311310301310300310300301311311300 ;
					301310300310311301311301300301311301311301311311 ;
					300301301301311301310310300310311301301300310301 ;
					310300311300311301300311301311311300311311300311 ;
					311311310311311301301300301300311300301310301301 ;
					301300311301310311300310301310300301301301310300 ;
					300311310310310311301301301301300301311300311310 ;
					310310300311310311311300300300300300301311301300 ;
					311301301300310311310311300311300300311310300310 ;
					301300310310311301311311310310301301301300300301 ;
					300311311301311301310300310301301301311301301311 ;
					310310301300311301300301311300301300301310311301 ;
					311301300311311301301310311311301300311311310311 ;
					301300300311301310310301311310310301301310310310 ;
					300311301300301310311310311301310301311311311300 ;
					310310311301301310301311310300310300301300301310 ;
					311301310310301310300300310311310300311301300300 ;
					301300301300300300301300300310311301301311300311 ;
					300311300311300300300311300301311301311310301301 ;
					310310310310300300310310301300311300301301311311 ;
					311301311301300300311301301311311300311300310301 ;
					301301300300300300301301301311300301300311311300 ;
					300310301311300300300310301300300301310310310310 ;
					310311311310300300310311300301300300300301300300 ;
					311300310301300300311300300310300300310300301310 ;
					301301301311301310310300310311301301300310301301 ;
					300310300300301310311311310300301301310311300311 ;
					310311310301301310301310311301301300300300310301 ;
					311300311310301310300301311310301300310301311311 ;
					301301311310311301311310311311310301300300311310 ;
					300310310301311301310301311300310301310301310300 ;
					310311300300311301300300310301310300300310300310 ;
					311300301311311301301311310310310300310311301300 ;
					301301310301310311300311300311311301300301301311 ;
					300310311310310311301300300300311301310300300301 ;
					310311301311310311311301301301311300300311310311 ;
					311300300300310311310310301310311300310310311301 ;
					311310311301310311310300310300300311300310300300 ;
					310301310310310311311311310311300311310311301310 ;
					300300300311310311301310311310300310300300311300 ;
					301311301300310311300301311301300310310301310310 ;
					311310310310311301301301301300301311300311310301 ;
					310301311301311301300310301311301311310310311311 ;
					300300301300311301310311300310301310300301301301 ;
					301311300311311301311300300301301310310300300311 ;
					311310300311301310300311300300310311300301300310 ;
					310301301300301310301300300311310311310300301300 ;
					300300311301301310311301301310310310300311311310 ;
					301311310310301310310310301301310310310310310300 ;
					311310301300300300311310311300311311300300310311 ;
					310301300311300300310301311311311311310301311301 ;
					300300310310300300300300310310311310300310301311 ;
					301311311301300300301311310301311310310311300301 ;
					311311300300300300311311310301300311301300301300 ;
					310300301311300300310300310310300311311301300310 ;
					300301311310300300300301311311300310301310310300 ;
					301310310301300300301310311300300310311311311310 ;
					311311301311301310300310301301301311301301311301 ;
					310300300300301310301301301310301311311300310311 ;
					300301310301301310311300300311301310301311300301 ;
					301310311310301310310311300300301310311310301311 ;
					311311311310311301301300300301310311301311301310 ;
					310300310301311301300311300310310311311310300300 ;
					300301300300311301310310301311310310301301310310 ;
					301310301311311301311301301300310310311300311300 ;
					311311310301310311310301311301311311301310311311 ;
					310300311310310311311310311310311311311311310301 ;
					300301301311310311301311310311311310301300300311 ;
					301310300300310311300300310300311310311301301301 ;
					311301301310311301301310310310300311311310310300 ;
					310310300301311301300301310301300311301311311310 ;
					300311310300311301310300311300300310311300301300 ;
					301300311311311301311311311311300310301301300310 ;
					311301300301310311310311301310301311311311300301 ;
					310310301310310311311300301301301311301310301311 ;
					300311311311310311301301300300301310311301311301 ;
					301300310300310311300310300311301310301300310311 ;
					311301310300300300311301300310310311311301310310 ;
					310310311311300300310310300301310311301300311300 ;
					300311301310300300300311301300310310311311301310 ;
					301300300301300300301300301311310310301310300300 ;
					311301311311301310300300311310311311311300300311 ;
					310310310300301310301311311301311311301301301301 ;
					300311300301301310311310310300311310311310311311 ;
					301300301310301310310301310311311310301311310301 ;
					311300310311301310300301310311300311310300311300 ;
					310311311300301310301310310300300311300301310310 ;
					300310301301301310311311311301300310310310300300 ;
					301301300310301310310300311310300310300311301310 ;
					311300311300300300311300301311301311310301301301 ;
					310311310311300300310311301300301311300300300311 ;
					300310300310300300300310300301301310310311310301 ;
					301301301301300300301301300310301310300310311311 ;
					311300301301310311310310300311310311310311311310 ;
					310311300310310311311301300300310311300310310300 ;
					300310310311310311301300301301310310310301300310 ;
					301301311300310311300311301310310310300300301300 ;
					311300300310311301301311311311311311310310301311 ;
					310311301301311301300300311300311311300311300301 ;
					300310311300311301310301310301311310310300310311 ;
					301301310311311301311310310310311310300301311301 ;
					310301310311301310301300311300300310310311300300 ;
					311310311300301310300311311311300310300310301310 ;
					301311301301301310310310310310300311310301311300 ;
					300300300310301310311301310301300311300300310310 ;
					310301311300300300310301300300301310310310310301 ;
					311310310311300300311310300311301310300311311311 ;
					301311300310300300301311301310301311310300301301 ;
					300300301301300300300300301301301311300301300311 ;
					310301301301310311311311301300310310310300300310 ;
					311310300310310311310300301311310310300301301300 ;
					301311310311310311300301300310310311310310311310 ;
					300300311300310311301310300301310311300311310300 ;
					310301300310311301300310310300311310310301310311 ;
					311310301301311301301301310311311310300300311301 ;
					301311311300311301311300311310311311310311301311 ;
					300300310311311301310311311301311311300310300301 ;
					310300301310311301300311311301300310311301301300 ;
					311311300301311301301300311310300310301300300310 ;
					301310310300311301311301310311300311311311310300 ;
					300301311311311301310310310300300311301310311310 ;
					310300300301310311311310300301301310311300311301 ;
					311311301310310311310301300310301310301301310311 ;
					301310311311310311300300301311301311311310300301 ;
					300301310300310311301311301300301311301311301311 ;
					310300310300300300310300301301310310311310301310 ;
					311311311311300300311311301310310310301311300300 ;
					301310301310300300301310300311310311311300310310 ;
					300301300301300300300301300300310311301301311300 ;
					310300311311301310301301310301311310311311311311 ;
					311311310300301310300310310310311310301310310301 ;
					301310300301301310310311311311311311311301300311 ;
					300301301310301310311300311300311311301300301301 ;
					310310300300300300310310311310300310301311310300 ;
					311301301311300300311301311301300310311310311310 ;
					301300311310300300301300310300300311301301301300 ;
					300311310301300300300311310311300311311300300310 ;
					310310301311301310301311300310301310301310300301 ;
					311301300300301310300300300301301310311311301311 ;
					301300310301301310310301301300301311301300311301 ;
					300311311310301310311310301311301311311301310311 ;
					310310311310311301300301301310310310301300310310 ;
					311301310301311301301310301301310310311301311300 ;
					301300300300311301311311300300310311301310301310 ;
					300311301311311301310300300311310311311311300300 ;
					310310310301310311311300310310311310301301300311 ;
					311301311310310311310311310301311310311300301301 ;
					301300301311310311300310311300311311301311311311 ;
					300311300300310311301301311311311311311310310301 ;
					310311311301310311311301311311300310300301311300 ;
					311300310310310311310310311300300310310300310310 ;
					301301300311310311300311310301300311300311300300 ;
					300310301300310311301300310310300311310310301310 ;
					310311310310311301300300300311301310300300301301 ;
					311300311301311301301311300300301310310301300311 ;
					301301301300311301311310301301301311300310310301 ;
					300310300311311301310301301310301311310311311311 ;
					310311300311301310301310301311310310300310311310 ;
					311300301300301310300301301300310310310311310300 ;
					301301311301301310310300300301310311300300300310 ;
					300310310310301310311311300310310311310301301300 ;
					310311301300300300310311310311311310300311301311 ;
					311300300311300300311300310300311310310310300301 ;
					301301310310300300301301311301311311300301310311 ;
					300310311301300300300310311310311311310300311301
				) ;
			$_crc.crc = Div ( $_crc.crc ; 1000000000000 ) ;	// right bitshift 8
			$_crc.crc = // _tableValue XOR $_crc.crc
				Substitute ( _tableValue + $_crc.crc ; [ 2 ; 0 ] ; [ 6 ; 3 ] ) ;

			// setup next character
			$_crc.i = $_crc.i + 1 ;
			$_crc.byte = Code ( Middle ( asciiText ; $_crc.i ; 1 ) ) ;
			$_crc.step =
				Case (
					IsEmpty ( $_crc.byte ) ; $_crc.step + 1 ;	// end
					$_crc.byte > 255 ; -2 ;	// out of range
					/* Else */ $_crc.step
				)
		] ;
			ChecksumCRC32 ( asciiText )
		) ;

	/* Step 2, clean-up and return result */
	$_crc.step = 2 or $_crc.step < 0 ;
		Let ( [
			_decimalCRC =
				Evaluate (
					"( ( ( ( ( ( ( ( ( ( ( ( ( ( ( "
					& Substitute ( 4 & $_crc.crc ;
						[ "43" ; "" ] ;
						[ 3 ; " ) * 4 + " ] ;
						[ "00" ; 0 ] ;
						[ "01" ; 1 ] ;
						[ "10" ; 2 ] ;
						[ "11" ; 3 ]
					)
				) ;
			_result =
				Case (
					$_crc.step = -1 ;	// empty input
						0 ;

					$_crc.step = -2 ;
						"ERROR: Character out of range ("
						& $_crc.byte
						& ")" ;

					/* Else, take one's complement of CRC */
						4294967295 - _decimalCRC
				) ;

			// purge variables
			$_crc.byte = "" ;
			$_crc.crc = "" ;
			$_crc.i = "" ;
			$_crc.step = ""
		] ;
			_result
		)
)